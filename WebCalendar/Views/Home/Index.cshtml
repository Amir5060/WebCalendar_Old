@{
    ViewBag.Title = "Home Page";
}
<!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>
@section scripts{
    <script>
        $(function () {
            function guid() {
                function s4() {
                    return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
                }
                return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                    s4() + '-' + s4() + s4() + s4();
            }

            var calendarMessaging = $.connection.calendarHub;
            $.connection.hub.start().done(function () {
                var uuid = guid();
                $('#userID').val(uuid);
                // $.connection.hub.id => this is very important. Without it, SignalR sends to all inculding the same user! Duplicate message.
                //calendarMessaging.server.newUser(uuid, $.connection.hub.id);
                $('#btnPopupSave').click(function () {
                    // Sends to server. Calls a method in server.
                    console.log("Here:" + $.connection.hub.id);
                    calendarMessaging.server.send($.connection.hub.id, $('#eventTitle').val(), moment($('#eventStart').val()), moment($('#eventEnd').val()));
                });

            });

            // Receive from server. Calls in the server.
            calendarMessaging.client.broadCastMessage = function (planId, title, startDate, endDate) {
                var eventData;
                eventData = {
                    title: title,
                    start: startDate,
                    end: endDate
                };
                $('#calendar').fullCalendar('renderEvent', eventData, true);
                console.log(userId);
            };
        });

        $(document).ready(function () {
            //console.log($('#popupEventForm'));
            //$('#popupEventForm').show();
            //console.log($('#popupEventForm'));
            var sourceFullView = { url: '/Home/GetDiaryEvents/' };
            var sourceSummaryView = { url: '/Home/GetDiarySummary/' };
            var CalLoading = true;

            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                defaultView: 'agendaWeek',
                editable: true,
                allDaySlot: false,
                selectable: true,
                slotMinutes: 15,
                firstDay: 1,
                //events: '/Home/GetDiaryEvents/',
                eventClick: function (calEvent, jsEvent, view) {
                    alert('You clicked on event id: ' + calEvent.id
                        + "\nSpecial ID: " + calEvent.someKey
                        + "\nAnd the title is: " + calEvent.title);

                },

                select: function (start, end) {
                    //alert(start);
                    $('#eventTitle').val("");
                    $('#eventStartDate').val(moment(start).format('DD/MM/YYYY HH:mm'));
                    $('#eventStart').val(start);
                    //$('#eventStartTime').val($.fullCalendar.formatDate(start, 'HH:mm'));
                    $('#eventEndDate').val(moment(end).format('DD/MM/YYYY HH:mm'));
                    $('#eventEnd').val(end);
                    //$('#eventEndTime').val($.fullCalendar.formatDate(end, 'HH:mm'));
                    ShowEventPopup(start);
                    //var title = $('#eventTitle').val();
                    //var title = prompt('Event name');
                    //var eventData;
                    //if (title) {
                    //    eventData = {
                    //        title: title,
                    //        start: start,
                    //        end: end
                    //    };
                    //    // Write in the caledar!
                    //    $('#calendar').fullCalendar('renderEvent', eventData, true);
                    //}
                    //$('#calendar').fullCalendar('unselect');
                },

                eventDrop: function (event, dayDelta, minuteDelta, allDay, revertFunc) {
                    if (confirm("Confirm move?")) {
                        UpdateEvent(event.id, event.start);
                    }
                    else {
                        revertFunc();
                    }
                },

                eventResize: function (event, dayDelta, minuteDelta, revertFunc) {

                    if (confirm("Confirm change appointment length?")) {
                        UpdateEvent(event.id, event.start, event.end);
                    }
                    else {
                        revertFunc();
                    }
                },



                dayClick: function (date, allDay, jsEvent, view) {
                    $('#eventTitle').val("");
                    $('#eventDate').val($.fullCalendar.formatDate(date, 'dd/MM/yyyy'));
                    $('#eventTime').val($.fullCalendar.formatDate(date, 'HH:mm'));
                    //ShowEventPopup(date);
                },

                viewRender: function (view, element) {

                    if (!CalLoading) {
                        if (view.name == 'month') {
                            // $('#calendar').fullCalendar('removeEventSource', sourceFullView);
                            $('#calendar').fullCalendar('removeEvents');
                            /// $('#calendar').fullCalendar('addEventSource', sourceSummaryView);
                        }
                        else {
                            ///$('#calendar').fullCalendar('removeEventSource', sourceSummaryView);
                            $('#calendar').fullCalendar('removeEvents');
                            //$('#calendar').fullCalendar('addEventSource', sourceFullView);
                        }
                    }
                },
                eventRender: function (event, element) {
                    element.attr('href', 'javascript:void(0);');
                    element.click(function () {
                        $("#startTime").html(moment(event.start).format('MMM Do h:mm A'));
                        $("#endTime").html(moment(event.end).format('MMM Do h:mm A'));
                        $("#eventInfo").html(event.description);
                        $("#eventLink").attr('href', event.url);
                        $("#eventContent").dialog({ modal: true, title: event.title, width: 350 });
                    });
                }

            });

            CalLoading = false;


        });

        $('#btnInit').click(function () {
            $.ajax({
                type: 'POST',
                //url: "/Home/Init",
                success: function (response) {
                    if (response == 'True') {
                        $('#calendar').fullCalendar('refetchEvents');
                        alert('Database populated! ');
                    }
                    else {
                        alert('Error, could not populate database!');
                    }
                }
            });
        });

        $('#btnPopupCancel').click(function () {
            ClearPopupFormValues();
            $('#popupEventForm').hide();
        });

        $('#btnPopupSave').click(function () {

            //$('#popupEventForm').hide();

            //var title = $('#eventTitle').val();
            //var eventData;
            //if (title) {
            //    eventData = {
            //        title: $('#eventTitle').val(),
            //        start: $('#eventStart').val(),
            //        end: $('#eventEnd').val()
            //    };
            //    // Write in the caledar!
            //    $('#calendar').fullCalendar('renderEvent', eventData, true);
            //}
            //$('#calendar').fullCalendar('unselect');

            //var dataRow = {
            //    'Title': $('#eventTitle').val(),
            //    'NewEventDate': $('#eventDate').val(),
            //    'NewEventTime': $('#eventTime').val(),
            //    'NewEventDuration': $('#eventDuration').val()
            //}

            //ClearPopupFormValues();

            //$.ajax({
            //    type: 'POST',
            //    url: "/Home/SaveEvent",
            //    data: dataRow,
            //    success: function (response) {
            //        if (response == 'True') {
            //            $('#calendar').fullCalendar('refetchEvents');
            //            alert('New event saved!');
            //        }
            //        else {
            //            alert('Error, could not save event!');
            //        }
            //    }
            //});
        });

        function ShowEventPopup(date) {
            ClearPopupFormValues();
            //$('#popupEventForm').show();
            $('#popupEventForm').modal('show');
            //console.log($('#eventTitle').focus());
            $('#popupEventForm').on('shown.bs.modal',
                function () {
                    $('#eventTitle').focus();
                });
            //$('#eventTitle').focus();
        }

        function ClearPopupFormValues() {
            $('#eventID').val("");
            $('#eventTitle').val("");
            $('#eventDateTime').val("");
            $('#eventDuration').val("");
        }

        function UpdateEvent(EventID, EventStart, EventEnd) {

            var dataRow = {
                'ID': EventID,
                'NewEventStart': EventStart,
                'NewEventEnd': EventEnd
            }

            $.ajax({
                type: 'POST',
                url: "/Home/UpdateEvent",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(dataRow)
            });
        }
    </script>
 }
<div class="container">
    <div id="calendar">

    </div>
    <input type="hidden" id="userID">
</div>

<div id="popupEventForm" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add new event</h3>
            </div>
            <div class="modal-body">
                <form id="EventForm" class="well">
                    <input type="hidden" id="eventID">
                    <div class="form-group">
                        <label>Event title</label>
                        <input class="form-control" type="text" id="eventTitle" placeholder="Title here">
                    </div>
                    <div class="form-group">
                        <label>Scheduled date</label>
                        <input class="form-control" type="text" id="eventStartDate">
                        <input class="form-control" type="text" id="eventStartTime">
                        <input type="hidden" id="eventStart">
                    </div>
                    <div class="form-group">
                        <label>Scheduled time</label>
                        <input class="form-control" type="text" id="eventEndDate">
                        <input class="form-control" type="text" id="eventEndTime">
                        <input type="hidden" id="eventEnd">
                    </div>
                    <div class="form-group">
                        <label>Appointment length (minutes)</label>
                        <input class="form-control" type="text" id="eventDuration" placeholder="15">
                    </div>
</form>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnPopupCancel" data-dismiss="modal" class="btn">Cancel</button>
                <button type="button" id="btnPopupSave" data-dismiss="modal" class="btn btn-primary">Save event</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
@*<div class="jumbotron">
    <h1>ASP.NET</h1>
    <p class="lead">ASP.NET is a free web framework for building great Web sites and Web applications using HTML, CSS and JavaScript.</p>
    <p><a href="http://asp.net" class="btn btn-primary btn-lg">Learn more &raquo;</a></p>
</div>

<div class="row">
    <div class="col-md-4">
        <h2>Getting started</h2>
        <p>
            ASP.NET MVC gives you a powerful, patterns-based way to build dynamic websites that
            enables a clean separation of concerns and gives you full control over markup
            for enjoyable, agile development.
        </p>
        <p><a class="btn btn-default" href="http://go.microsoft.com/fwlink/?LinkId=301865">Learn more &raquo;</a></p>
    </div>
    <div class="col-md-4">
        <h2>Get more libraries</h2>
        <p>NuGet is a free Visual Studio extension that makes it easy to add, remove, and update libraries and tools in Visual Studio projects.</p>
        <p><a class="btn btn-default" href="http://go.microsoft.com/fwlink/?LinkId=301866">Learn more &raquo;</a></p>
    </div>
    <div class="col-md-4">
        <h2>Web Hosting</h2>
        <p>You can easily find a web hosting company that offers the right mix of features and price for your applications.</p>
        <p><a class="btn btn-default" href="http://go.microsoft.com/fwlink/?LinkId=301867">Learn more &raquo;</a></p>
    </div>
</div>*@